{% extends "base.html" %}

{% block title %}Chat - LauraBot{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
{% endblock %}

{% block content %}
<div class="chat-layout">
    <header class="chat-header">
        <h2>
            <span class="material-icons">smart_toy</span>
            LauraBot
            <span class="status-indicator" title="Online"></span>
        </h2>
        
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="{{ url_for('auth_bp.perfil') }}" title="Gerenciar Estudantes" style="color: white; text-decoration: none;">
                <span class="material-icons">manage_accounts</span>
            </a>
            
            <a href="{{ url_for('auth_bp.logout') }}" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.9rem;">
                Sair
            </a>
        </div>
    </header>

    <div id="chat-history" class="chat-history">
        {# 1. Se houver histórico antigo, renderiza #}
        {% if historico %}
            {% for msg in historico %}
                <div class="message {% if msg.role == 'user' %}message-user{% else %}message-bot{% endif %}">
                    {# O filtro safe permite renderizar HTML se o bot mandar Markdown convertido, mas cuidado com XSS do user #}
                    {% if msg.role == 'assistant' %}
                        {# O JS no frontend vai tratar Markdown, mas aqui precisamos renderizar o texto cru ou tratar no backend. 
                           Para simplificar e manter consistência com o JS, vamos deixar o JS formatar ou renderizar texto puro por enquanto. 
                           OBS: Se a mensagem salva já tiver Markdown, o ideal seria renderizar aqui. #}
                        <div class="markdown-content">{{ msg.content }}</div>
                    {% else %}
                        {{ msg.content }}
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}

        {# 2. Se for início de conversa, mostra a saudação #}
        {% if mensagem_inicial %}
        <div class="message message-bot">
            {{ mensagem_inicial }}
        </div>
        {% endif %}
    </div>

    <div id="typing-indicator" class="typing-indicator">LauraBot está digitando...</div>

    <div class="input-area">
        <input type="text" id="user-input" class="chat-input" placeholder="Digite sua dúvida aqui..." autocomplete="off">
        <button id="btn-send" class="btn-send">
            <span class="material-icons">send</span>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{# Pequeno script para renderizar o Markdown das mensagens antigas ao carregar #}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Renderiza Markdown das mensagens do bot carregadas do histórico
        document.querySelectorAll('.markdown-content').forEach(el => {
            el.innerHTML = marked.parse(el.textContent);
        });
        
        // Rola para o final
        const chatHistory = document.getElementById('chat-history');
        chatHistory.scrollTop = chatHistory.scrollHeight;
    });
</script>
{% endblock %}