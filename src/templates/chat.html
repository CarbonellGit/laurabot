{% extends "base.html" %}

{% block title %}Chat - LauraBot{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
{% endblock %}

{% block content %}
<div class="chat-layout">
    <header class="chat-header">
        <h2>
            <span class="material-icons">smart_toy</span>
            LauraBot
            <span class="status-indicator" title="Online"></span>
        </h2>
        
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="{{ url_for('auth_bp.perfil') }}" title="Gerenciar Estudantes" style="color: white; text-decoration: none;">
                <span class="material-icons">manage_accounts</span>
            </a>
            
            <a href="{{ url_for('auth_bp.logout') }}" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.9rem;">
                Sair
            </a>
        </div>
    </header>

    <div id="chat-history" class="chat-history">
        {# 1. Renderiza mensagens do histórico #}
        {% if historico %}
            {% for msg in historico %}
                <div class="message {% if msg.role == 'user' %}message-user{% else %}message-bot{% endif %}">
                    {% if msg.role == 'assistant' %}
                        {# ESTRATÉGIA SEGURA: O texto cru começa VISÍVEL. O JS o esconde depois. #}
                        <div class="markdown-render-target">{{ msg.content }}</div>
                        <div class="markdown-output" style="display: none;"></div>
                    {% else %}
                        {{ msg.content }}
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}

        {# 2. Mensagem Inicial #}
        {% if mensagem_inicial %}
        <div class="message message-bot">
            {# O mesmo vale aqui. Se o JS falhar, o usuário vê o markdown cru, mas vê a mensagem! #}
            <div class="markdown-render-target">{{ mensagem_inicial }}</div>
            <div class="markdown-output" style="display: none;"></div>
        </div>
        {% endif %}
    </div>

    <div id="typing-indicator" class="typing-indicator">LauraBot está digitando...</div>

    <div class="input-area">
        <input type="text" id="user-input" class="chat-input" placeholder="Digite sua dúvida aqui..." autocomplete="off">
        <button id="btn-send" class="btn-send">
            <span class="material-icons">send</span>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>

{# Script Robusto de Renderização #}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Verifica se a biblioteca marked carregou
        const hasMarked = typeof marked !== 'undefined';
        if (!hasMarked) console.warn("Aviso: Biblioteca 'marked' não carregada. Exibindo texto bruto.");

        const targets = document.querySelectorAll('.message-bot');

        targets.forEach(msgDiv => {
            const rawSource = msgDiv.querySelector('.markdown-render-target');
            const outputDiv = msgDiv.querySelector('.markdown-output');

            if (rawSource && outputDiv && hasMarked) {
                try {
                    // 1. Pega o texto
                    const rawText = rawSource.textContent;
                    // 2. Converte
                    const htmlContent = marked.parse(rawText);
                    
                    // 3. Verifica se a conversão gerou algo válido
                    if (htmlContent && htmlContent.trim() !== "") {
                        outputDiv.innerHTML = htmlContent;
                        
                        // 4. TROCA SEGURA DE VISIBILIDADE
                        outputDiv.style.display = 'block';
                        rawSource.style.display = 'none';
                    }
                } catch (e) {
                    console.error("Erro ao renderizar markdown:", e);
                    // Em caso de erro, mantém o original visível (fallback)
                }
            }
        });
        
        // Scroll para o final
        const chatHistory = document.getElementById('chat-history');
        if(chatHistory) {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    });
</script>
{% endblock %}