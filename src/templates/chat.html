{% extends "base.html" %}

{% block title %}Chat - LauraBot{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
{% endblock %}

{% block content %}
<div class="chat-layout">
    <header class="chat-header">
        <h2>
            <span class="material-icons">smart_toy</span>
            LauraBot
            <span class="status-indicator" title="Online"></span>
        </h2>
        
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="{{ url_for('auth_bp.perfil') }}" title="Gerenciar Estudantes" style="color: white; text-decoration: none;">
                <span class="material-icons">manage_accounts</span>
            </a>
            
            <a href="{{ url_for('auth_bp.logout') }}" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.9rem;">
                Sair
            </a>
        </div>
    </header>

    <div id="chat-history" class="chat-history">
        {# 1. Renderiza mensagens do histórico (Se houver navegação interna ou F5 com persistência futura) #}
        {% if historico %}
            {% for msg in historico %}
                <div class="message {% if msg.role == 'user' %}message-user{% else %}message-bot{% endif %}">
                    {% if msg.role == 'assistant' %}
                        {# TRUQUE DE FRONTEND PARA MARKDOWN ROBUSTO: 
                           Guardamos o conteúdo cru (Markdown) num container oculto 
                           e deixamos o JS preencher o container visível com HTML formatado. 
                        #}
                        <div class="markdown-render-target" style="display: none;">{{ msg.content }}</div>
                        <div class="markdown-output"></div>
                    {% else %}
                        {{ msg.content }}
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}

        {# 2. Mensagem Inicial (Sempre aparece em nova sessão/refresh) #}
        {% if mensagem_inicial %}
        <div class="message message-bot">
            {# A mensagem inicial também pode ter markdown (negritos), então usamos a mesma lógica #}
            <div class="markdown-render-target" style="display: none;">{{ mensagem_inicial }}</div>
            <div class="markdown-output"></div>
        </div>
        {% endif %}
    </div>

    <div id="typing-indicator" class="typing-indicator">LauraBot está digitando...</div>

    <div class="input-area">
        <input type="text" id="user-input" class="chat-input" placeholder="Digite sua dúvida aqui..." autocomplete="off">
        <button id="btn-send" class="btn-send">
            <span class="material-icons">send</span>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>

{# Script Específico para formatar mensagens estáticas (vindas do servidor) #}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Seleciona todas as mensagens do bot que precisam de renderização
        // (Isso cobre tanto o histórico quanto a mensagem inicial)
        const targets = document.querySelectorAll('.message-bot');

        targets.forEach(msgDiv => {
            const rawSource = msgDiv.querySelector('.markdown-render-target');
            const outputDiv = msgDiv.querySelector('.markdown-output');

            if (rawSource && outputDiv) {
                // Pega o texto Markdown cru vindo do Python
                const rawText = rawSource.textContent;
                
                // Converte para HTML usando a biblioteca 'marked' (carregada no base.html)
                // e insere na div de saída
                outputDiv.innerHTML = marked.parse(rawText);
            }
        });
        
        // Garante que o scroll vá para o final após a renderização
        const chatHistory = document.getElementById('chat-history');
        if(chatHistory) {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    });
</script>
{% endblock %}