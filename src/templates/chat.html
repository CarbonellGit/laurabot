{% extends "base.html" %}

{% block title %}Chat - LauraBot{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
{% endblock %}

{% block content %}
<div class="chat-layout">
    <header class="chat-header">
        <h2>
            <span class="material-icons">smart_toy</span>
            LauraBot
            <span class="status-indicator" title="Online"></span>
        </h2>
        
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="{{ url_for('auth_bp.perfil') }}" title="Gerenciar Estudantes" style="color: white; text-decoration: none;">
                <span class="material-icons">manage_accounts</span>
            </a>
            
            <a href="{{ url_for('auth_bp.logout') }}" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.9rem;">
                Sair
            </a>
        </div>
    </header>

    <div id="chat-history" class="chat-history">
        {# 1. Se houver histórico antigo (Recarregamento/F5), renderiza #}
        {% if historico %}
            {% for msg in historico %}
                <div class="message {% if msg.role == 'user' %}message-user{% else %}message-bot{% endif %}">
                    {% if msg.role == 'assistant' %}
                        {# TRUQUE DE FRONTEND: 
                           Guardamos o conteúdo cru no atributo 'hidden' (data-content) 
                           e deixamos a div vazia ou com loader para o JS preencher formatado. 
                        #}
                        <div class="markdown-render-target" style="display: none;">{{ msg.content }}</div>
                        <div class="markdown-output"></div>
                    {% else %}
                        {{ msg.content }}
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}

        {# 2. Mensagem Inicial (Sempre aparece se histórico for novo) #}
        {% if mensagem_inicial %}
        <div class="message message-bot">
            <div class="markdown-output">{{ mensagem_inicial }}</div>
        </div>
        {% endif %}
    </div>

    <div id="typing-indicator" class="typing-indicator">LauraBot está digitando...</div>

    <div class="input-area">
        <input type="text" id="user-input" class="chat-input" placeholder="Digite sua dúvida aqui..." autocomplete="off">
        <button id="btn-send" class="btn-send">
            <span class="material-icons">send</span>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>

{# Script Específico para formatar mensagens que vieram do Backend (F5) #}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Seleciona todos os blocos que precisam de renderização
        const targets = document.querySelectorAll('.message-bot');

        targets.forEach(msgDiv => {
            const rawSource = msgDiv.querySelector('.markdown-render-target');
            const outputDiv = msgDiv.querySelector('.markdown-output');

            if (rawSource && outputDiv) {
                // Pega o texto cru do Python
                const rawText = rawSource.textContent;
                // Converte para HTML com Marked
                outputDiv.innerHTML = marked.parse(rawText);
                // Exibe o resultado
                outputDiv.style.display = 'block';
            }
        });
        
        // Rola para o final após renderizar
        const chatHistory = document.getElementById('chat-history');
        if(chatHistory) chatHistory.scrollTop = chatHistory.scrollHeight;
    });
</script>
{% endblock %}